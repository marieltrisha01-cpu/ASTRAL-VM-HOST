name: Advanced RDP Server (WinServer 2025)

on:
  workflow_dispatch:
    inputs:
      duration_hours:
        description: 'VM Life Duration (Default 6h, Max 6h)'
        required: false
        default: '6'

jobs:
  deploy:
    runs-on: windows-2025
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Restore Persistent State
        id: restore-state
        uses: actions/cache/restore@v4
        with:
          path: C:\State
          key: rdpdev-state-${{ github.run_id }}
          restore-keys: |
            rdpdev-state-

      - name: Setup Profile Structure
        run: |
          if (!(Test-Path C:\State)) { New-Item -Path C:\State -ItemType Directory }
          if (!(Test-Path C:\State\Profile)) { New-Item -Path C:\State\Profile -ItemType Directory }

      - name: Install Tailscale
        shell: powershell
        run: |
          curl.exe -L https://pkgs.tailscale.com/stable/tailscale-setup64.exe -o tailscale-setup.exe
          start-process -FilePath .\tailscale-setup.exe -ArgumentList "/quiet", "/norestart" -Wait
          $env:Path += ";C:\Program Files\Tailscale"
          tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --hostname gh-win-server-2025

      - name: Provision Environment
        shell: powershell
        env:
          VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          ./provision.ps1
          # Ansible verification (idempotent)
          ansible-playbook site.yml

      - name: Keep VM Alive & Auto-Checkpoint
        shell: powershell
        run: |
          Write-Host "VM remains active for ${{ github.event.inputs.duration_hours }} hours."
          $totalSeconds = [int]${{ github.event.inputs.duration_hours }} * 3600
          $elapsed = 0
          while ($elapsed -lt $totalSeconds) {
              # Check for user logout or activity here if needed
              # Heartbeat to Tailscale to prevent disconnect
              tailscale status > $null
              Start-Sleep -Seconds 60
              $elapsed += 60
              
              # Warning: GHA 6-hour hard limit
              if ($elapsed -ge 21000) { # 5h 50m warning
                Write-Host "CRITICAL: 10 MINUTES UNTIL GHA HARD TIMEOUT. FINALIZE WORK." -ForegroundColor Red
              }
          }

      - name: Finalize & Backup State
        if: always()
        uses: actions/cache/save@v4
        with:
          path: C:\State
          key: rdpdev-state-${{ github.run_id }}

      - name: Remote Cloud Mirror (Rclone)
        if: always()
        env:
          RCLONE_CONFIG_DATA: ${{ secrets.RCLONE_CONFIG_DATA }}
        run: |
          if ("$env:RCLONE_CONFIG_DATA") {
            ./scripts/rclone-sync.ps1
          } else {
            Write-Host "Skipping cloud mirror: RCLONE_CONFIG_DATA not set."
          }
