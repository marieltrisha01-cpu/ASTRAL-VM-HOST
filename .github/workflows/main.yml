name: Advanced RDP Server (WinServer 2025)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-2025
    timeout-minutes: 360
    env:
      VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      RCLONE_CONFIG_DATA: ${{ secrets.RCLONE_CONFIG_DATA }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Restore Persistence Cache
        uses: actions/cache@v4
        with:
          path: C:\State
          key: rdp-state-${{ github.run_id }}
          restore-keys: |
            rdp-state-

      - name: Install Tailscale
        shell: powershell
        run: |
          winget install --id Tailscale.Tailscale --accept-package-agreements --accept-source-agreements --silent
          Start-Sleep -Seconds 5
          & 'C:\Program Files\Tailscale\tailscale.exe' up --authkey "$env:TAILSCALE_AUTH_KEY" --hostname "gh-win-server-2025" --accept-routes
          & 'C:\Program Files\Tailscale\tailscale.exe' status

      - name: Provision Environment
        shell: powershell
        run: |
          ./provision.ps1

      - name: Keep VM Alive & Auto-Checkpoint
        shell: powershell
        run: |
          Write-Host "VM active. Self-Healing Active (Check every 60s)."
          $startTime = Get-Date
          while ((Get-Date) -lt $startTime.AddMinutes(350)) {
              # 1. Connectivity Check
              & 'C:\Program Files\Tailscale\tailscale.exe' status > $null
              if ($LASTEXITCODE -ne 0) {
                  Write-Host "Tailscale disconnected. Attempting auto-reconnect..." -ForegroundColor Yellow
                  & 'C:\Program Files\Tailscale\tailscale.exe' up --authkey "$env:TAILSCALE_AUTH_KEY" --hostname "gh-win-server-2025" --accept-routes
              }
              
              # 2. Checkpoint Logic (Every 30 Minutes)
              $elapsed = ((Get-Date) - $startTime).TotalMinutes
              if ([int]$elapsed % 30 -eq 0) {
                  Write-Host "Performing periodic cloud checkpoint..." -ForegroundColor Cyan
                  ./scripts/rclone-sync.ps1
              }
              
              Start-Sleep -Seconds 60
          }

      - name: Finalize & Backup State
        if: always()
        uses: actions/cache/save@v4
        with:
          path: C:\State
          key: rdp-state-${{ github.run_id }}

      - name: Remote Cloud Mirror (Final)
        if: always()
        shell: powershell
        run: |
          ./scripts/rclone-sync.ps1
