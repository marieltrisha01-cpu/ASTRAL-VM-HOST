name: Advanced RDP Server (WinServer 2025)

on:
  workflow_dispatch:
    inputs:
      duration_hours:
        description: 'VM Life Duration (Default 6h, Max 6h)'
        required: false
        default: '6'

jobs:
  deploy:
    runs-on: windows-2025
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Restore Persistent State
        id: restore-state
        uses: actions/cache/restore@v4
        with:
          path: C:\State
          key: rdpdev-state-${{ github.run_id }}
          restore-keys: |
            rdpdev-state-

      - name: Setup Profile Structure
        run: |
          if (!(Test-Path C:\State)) { New-Item -Path C:\State -ItemType Directory }
          if (!(Test-Path C:\State\Profile)) { New-Item -Path C:\State\Profile -ItemType Directory }

      - name: Install Tailscale
        shell: powershell
        run: |
          # Use the universal stable installer URL
          curl.exe -L https://pkgs.tailscale.com/stable/tailscale-setup.exe -o tailscale-setup.exe
          start-process -FilePath .\tailscale-setup.exe -ArgumentList "/quiet", "/norestart" -Wait
          $env:Path += ";C:\Program Files\Tailscale"
          tailscale up --authkey ${{ secrets.TAILSCALE_AUTH_KEY }} --hostname gh-win-server-2025

      - name: Provision Environment
        shell: powershell
        env:
          VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          ./provision.ps1
          # Ansible verification (idempotent)
          ansible-playbook site.yml

      - name: Keep VM Alive & Auto-Checkpoint
        shell: powershell
        env:
          RCLONE_CONFIG_DATA: ${{ secrets.RCLONE_CONFIG_DATA }}
        run: |
          Write-Host "VM active. Safety duration set to 5h 50m to ensure state save."
          $maxSeconds = 21000 # 5h 50m
          $elapsed = 0
          while ($elapsed -lt $maxSeconds) {
              tailscale status > $null
              
              # Periodic Cloud Checkpoint (Every 30 mins)
              if ($elapsed -gt 0 -and ($elapsed % 1800) -eq 0) {
                  Write-Host "Triggering Periodic Checkpoint..." -ForegroundColor Cyan
                  if ($env:RCLONE_CONFIG_DATA) {
                    ./scripts/rclone-sync.ps1
                  }
              }

              Start-Sleep -Seconds 60
              $elapsed += 60
              
              if ($elapsed -ge 20400) { # 5h 40m warning
                Write-Host "CRITICAL: 10 MINUTES UNTIL AUTO-CHECKPOINT & SHUTDOWN." -ForegroundColor Red
              }
          }

      - name: Finalize & Backup State
        if: always()
        uses: actions/cache/save@v4
        with:
          path: C:\State
          key: rdpdev-state-${{ github.run_id }}

      - name: Remote Cloud Mirror (Final)
        if: always()
        env:
          RCLONE_CONFIG_DATA: ${{ secrets.RCLONE_CONFIG_DATA }}
        run: |
          if ("$env:RCLONE_CONFIG_DATA") {
            ./scripts/rclone-sync.ps1
          }
