name: Advanced RDP Server (WinServer 2025)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: "Duration to keep the VM alive (in hours)"
        required: true
        default: "6"

permissions: write-all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: windows-2025
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create State Directory
        run: |
          mkdir C:\State
          echo "Server 2025 State" > C:\State\init.txt

      - name: Restore Persistence Layer
        id: restore-state
        uses: actions/download-artifact@v4
        with:
          name: state
          path: C:\State_Zips
        continue-on-error: true

      - name: Extract State
        shell: powershell
        run: |
          if (Test-Path "C:\State_Zips\state.zip") {
            Write-Host "Restoring state from previous session..."
            Expand-Archive -Path "C:\State_Zips\state.zip" -DestinationPath "C:\State" -Force
          } else {
            Write-Host "No previous state found. Starting fresh."
          }

      - name: Install Tailscale
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "tailscale-setup.exe"
          Start-Process -FilePath "tailscale-setup.exe" -ArgumentList "/quiet", "/norestart" -Wait
          "C:\Program Files\Tailscale" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          if (Test-Path "C:\State\server-state.conf") {
            Write-Host "Restoring Tailscale Identity..."
            Stop-Service Tailscale
            Copy-Item "C:\State\server-state.conf" "C:\ProgramData\Tailscale\server-state.conf" -Force
            Start-Service Tailscale
          }

          & "C:\Program Files\Tailscale\tailscale.exe" version

      - name: Connect to Tailscale
        shell: powershell
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "Checking Tailscale Auth Key..."
          if ($env:TAILSCALE_AUTHKEY) {
            Write-Host "Auth Key is present. Length: $($env:TAILSCALE_AUTHKEY.Length)"
          } else {
            Write-Error "TAILSCALE_AUTHKEY environment variable is missing!"
            exit 1
          }
          Start-Process -FilePath "C:\Program Files\Tailscale\tailscale.exe" -ArgumentList "up --authkey=""$env:TAILSCALE_AUTHKEY"" --hostname=""gh-win-server-2025"" --accept-routes --advertise-exit-node" -NoNewWindow -Wait

      - name: Run Provisioning Script
        shell: pwsh
        env:
          VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
        run: |
          # 1. State Directory Scaffolding
          $StateDir = 'C:\State';
          $BaseProfile = 'C:\Users\runneradmin';
          $ProfileRoot = Join-Path $StateDir 'Profile';
          if (-not (Test-Path $StateDir)) { New-Item -Path $StateDir -ItemType Directory -Force | Out-Null };
          if (-not (Test-Path $ProfileRoot)) { New-Item -Path $ProfileRoot -ItemType Directory -Force | Out-Null };

          # 2. Prevent Locked Files
          $AppsToKill = @('chrome', 'msedge', 'onedrive', 'teams', 'skype', 'explorer');
          foreach ($App in $AppsToKill) { Stop-Process -Name $App -Force -ErrorAction SilentlyContinue };
          Start-Sleep -Seconds 2;

          # 3. Registry-Based Shell Folder Redirection
          $ShellFoldersKey = 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders';
          $Redirections = @{
              'Desktop'   = "$ProfileRoot\Desktop";
              'Personal'  = "$ProfileRoot\Documents";
              'My Pictures' = "$ProfileRoot\Pictures";
              'My Video'  = "$ProfileRoot\Videos";
              '{374DE296-1261-41E8-A953-973F9238B61A}' = "$ProfileRoot\Downloads";
          };
          foreach ($Key in $Redirections.Keys) {
              if (-not (Test-Path $Redirections[$Key])) { New-Item -Path $Redirections[$Key] -ItemType Directory -Force | Out-Null };
              Set-ItemProperty -Path $ShellFoldersKey -Name $Key -Value $Redirections[$Key] -Force;
          }

          # 4. Junction-Based AppData & System Persistence
          $JunctionMaps = @(
              @{ Source = 'AppData\Roaming'; Target = "$ProfileRoot\AppData\Roaming" },
              @{ Source = 'AppData\Local'; Target = "$ProfileRoot\AppData\Local" },
              @{ Source = '.ssh'; Target = "$ProfileRoot\.ssh" }
          );
          foreach ($Map in $JunctionMaps) {
              $SourcePath = Join-Path $BaseProfile $Map.Source;
              $TargetPath = $Map.Target;
              if (-not (Test-Path $TargetPath)) { New-Item -Path $TargetPath -ItemType Directory -Force | Out-Null };
              if (Test-Path $SourcePath) {
                  $Item = Get-Item $SourcePath;
                  if ($Item.Attributes -notlike '*ReparsePoint*') {
                      Get-ChildItem -Path $SourcePath | Move-Item -Destination $TargetPath -Force -ErrorAction SilentlyContinue;
                      Remove-Item $SourcePath -Recurse -Force;
                      New-Item -ItemType Junction -Path $SourcePath -Target $TargetPath -Force | Out-Null;
                  }
              } else {
                  New-Item -ItemType Junction -Path $SourcePath -Target $TargetPath -Force | Out-Null;
              }
          }

          # 5. Networking & Firewall Hardening
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False;
          netsh advfirewall firewall add rule name="RDP-TCP-In-Definitive" dir=in action=allow protocol=TCP localport=3389 profile=any;
          netsh advfirewall firewall add rule name="SSH-TCP-In-Definitive" dir=in action=allow protocol=TCP localport=22 profile=any;

          # 6. Service Health & RDP Binding
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0 -Force;
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name 'UserAuthentication' -Value 0 -Force;
          Restart-Service TermService -Force -ErrorAction SilentlyContinue;

          # 7. User Configuration
          if ($env:VM_PASSWORD) {
              $Password = $env:VM_PASSWORD | ConvertTo-SecureString -AsPlainText -Force;
              Set-LocalUser -Name 'runneradmin' -Password $Password;
              Add-LocalGroupMember -Group 'Remote Desktop Users' -Member 'runneradmin' -ErrorAction SilentlyContinue;
              Add-LocalGroupMember -Group 'Administrators' -Member 'runneradmin' -ErrorAction SilentlyContinue;
          }
          Start-Process explorer;

      - name: VM Status & Connection Info
        shell: pwsh
        run: |
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4;
          Write-Host "==========================================" -ForegroundColor Cyan;
          Write-Host "SERVER 2025 IS READY (pwsh MODE)" -ForegroundColor Cyan;
          Write-Host "Tailscale IP: $ip" -ForegroundColor Yellow;
          Write-Host "Hostname: gh-win-server-2025" -ForegroundColor Yellow;
          Write-Host "Username: runneradmin" -ForegroundColor Yellow;
          Write-Host "Access via RDP or SSH using Tailscale IP" -ForegroundColor White;
          Write-Host "==========================================" -ForegroundColor Cyan;

          # Discord Notification Integration
          if ("${{ secrets.DISCORD_WEBHOOK }}") {
            $body = @{
              content = "üöÄ **ASTRAL-VM Server 2025 Ready**`n`nüìç **IP:** ``$ip`` `nüë§ **User:** ``runneradmin`` `nüîë **Pass:** ``${{ github.event.inputs.duration }}h duration``"
            } | ConvertTo-Json;
            Invoke-RestMethod -Uri "${{ secrets.DISCORD_WEBHOOK }}" -Method Post -Body $body -ContentType "application/json";
          }

      - name: Keep VM Alive
        shell: powershell
        run: |
          $hours = [int]${{ github.event.inputs.duration }}
          $endTime = (Get-Date).AddHours($hours)
          Write-Host "VM will stay alive until $endTime (approx $hours hours)"

          while ((Get-Date) -lt $endTime) {
            $status = & "C:\Program Files\Tailscale\tailscale.exe" status --json | ConvertFrom-Json
            if ($status.BackendState -ne "Running") {
               Write-Host "Tailscale disconnected! Reconnecting..." -ForegroundColor Yellow
               & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" --hostname="gh-win-server-2025"
            }
            Start-Sleep -Seconds 60
          }

      - name: Install Rclone
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://downloads.rclone.org/rclone-current-windows-amd64.zip" -OutFile "rclone.zip"
          Expand-Archive -Path "rclone.zip" -DestinationPath "C:\rclone"
          Move-Item "C:\rclone\rclone-*-windows-amd64\rclone.exe" "C:\Windows\System32\rclone.exe"
          rclone version

      - name: Restore from Remote Cloud (Optional)
        shell: powershell
        env:
          RCLONE_CONFIG_DATA: ${{ secrets.RCLONE_CONFIG }}
        run: |
          if ($env:RCLONE_CONFIG_DATA) {
            $configPath = "$HOME\.config\rclone\rclone.conf"
            New-Item -Path (Split-Path $configPath) -ItemType Directory -Force
            $env:RCLONE_CONFIG_DATA | Out-File $configPath -Encoding utf8
            Write-Host "Syncing from remote cloud..."
            rclone sync "remote:rdpdev-state" "C:\State" -v
          }

      - name: Teardown & Multi-Cloud Backup
        if: always()
        shell: powershell
        env:
          RCLONE_CONFIG_DATA: ${{ secrets.RCLONE_CONFIG }}
        run: |
          Write-Host "Backing up Tailscale Identity..."
          if (Test-Path "C:\ProgramData\Tailscale\server-state.conf") {
             Copy-Item "C:\ProgramData\Tailscale\server-state.conf" "C:\State\server-state.conf" -Force
          }

          Write-Host "Creating session snapshot..."
          Compress-Archive -Path "C:\State\*" -DestinationPath "C:\state.zip" -Force

          if ($env:RCLONE_CONFIG_DATA) {
            Write-Host "Mirroring state to remote cloud..."
            rclone sync "C:\State" "remote:rdpdev-state" -v
          }

      - name: Upload GitHub Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: state
          path: C:\state.zip
          retention-days: 7
