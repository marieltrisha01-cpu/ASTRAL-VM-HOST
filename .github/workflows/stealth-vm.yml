name: Stealth VM (RDP + Auto-Heal)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'  # Auto-Heal every 5 hours

jobs:
  virtual-machine:
    runs-on: windows-latest
    timeout-minutes: 350
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    # 1. Setup Environment & Tools
    - name: Install Essentials
      run: |
        choco install rclone -y
        pip install py7zr
        
    # 2. "Resurrection" - Pull State from Cloud
    - name: Restore Soul (State)
      env:
        RCLONE_CONFIG_PASS: ${{ secrets.RCLONE_CONFIG_PASS }}
        RCLONE_CONFIG_BLOB: ${{ secrets.RCLONE_CONFIG_BLOB }}
      run: |
        if ($env:RCLONE_CONFIG_BLOB) {
            $env:RCLONE_CONFIG_BLOB | Out-File -Encoding UTF8 rclone.conf
        }
        mkdir C:\EnterpriseState -ErrorAction SilentlyContinue
        
        # Download state.zip (e.g. from TeraBox/GDrive alias 'remote')
        if (Test-Path rclone.conf) {
            rclone copy remote:backups/state.zip . --config rclone.conf --ignore-errors
        }
        
        # Unzip if exists
        if (Test-Path state.zip) {
          7z x state.zip -oC:\EnterpriseState
        } else {
          Write-Host "New Life Started - Clean State."
        }

    # 3. Enable RDP & Ngrok Tunnel (Robust Mode)
    - name: Start Ngrok Tunnel
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      run: |
        choco install ngrok -y
        
        # 1. Validate Token
        if (-not $env:NGROK_AUTH_TOKEN) {
            Write-Error "CRITICAL: NGROK_AUTH_TOKEN secret is MISSING."
            exit 1
        }
        
        # 2. Configure Ngrok (Main Shell)
        $ngrokPath = (Get-Command ngrok).Source
        & $ngrokPath authtoken $env:NGROK_AUTH_TOKEN
        
        Write-Host "Ngrok Executable Found: $ngrokPath"
        
        # 3. Start Ngrok in Background Job using Absolute Path
        $job = Start-Job -ScriptBlock {
            param($path)
            # Use 'Call Operator' & and redirect output
            & $path tcp 3389 --log=stdout > ngrok_debug.log 2>&1
        } -ArgumentList $ngrokPath
        
        # 4. Wait for Tunnel
        $url = $null
        for ($i = 0; $i -lt 30; $i++) {
            Start-Sleep -Seconds 2
            
            # Check if job crashed
            if ($job.State -ne 'Running') {
                Write-Error "Ngrok Job CRASHED."
                Receive-Job $job
                if (Test-Path ngrok_debug.log) { 
                    Write-Host "--- Ngrok Logs ---"
                    Get-Content ngrok_debug.log 
                }
                exit 1
            }

            try {
                $json = Invoke-RestMethod http://localhost:4040/api/tunnels -ErrorAction Stop
                $url = $json.tunnels[0].public_url
                if ($url) { break }
            } catch {
                Write-Host "Waiting for API... ($i/30)"
            }
        }

        if (-not $url) {
            Write-Error "Timed out waiting for URL."
            if (Test-Path ngrok_debug.log) { Get-Content ngrok_debug.log }
            exit 1
        }

        Write-Host "::notice::RDP ADDRESS: $url"
        $url | Out-File RDP_CONNECTION.txt

    - name: Enable Windows RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1
        net user runneradmin "${{ secrets.VM_PASSWORD }}" /add
        net localgroup administrators runneradmin /add

    # 4. Keep Alive & Auto-Heal Sync Loop
    - name: Run & Sync Loop
      run: |
        $counter = 0
        while ($true) {
          Start-Sleep -Seconds 1800 # Sync every 30 mins
          
          # "Save Soul" - Push State to Cloud
          if (Test-Path rclone.conf) {
             7z a state.zip C:\EnterpriseState\*
             rclone copy state.zip remote:backups/ --config rclone.conf --ignore-errors
             Write-Host "Auto-Heal Checkpoint $counter Saved."
          } else {
             Write-Host "No Cloud Config - Running Ephemeral Mode"
          }
          $counter++
        }
