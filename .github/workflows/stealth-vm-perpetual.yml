name: Stealth VM - Perpetual (365 Days)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'VM runtime duration in hours (max 6)'
        required: false
        default: '5'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'
  schedule:
    # Run every 22 hours (staggered for stealth)
    - cron: '0 */22 * * *'

env:
  STATE_PATH: 'C:\EnterpriseState'
  SYNC_INTERVAL: 1800  # 30 minutes in seconds
  NGROK_REGION: 'us'

jobs:
  stealth-vm:
    runs-on: windows-latest
    timeout-minutes: 350  # Just under 6 hours

    steps:
      - name: Initialize - Stealth VM Boot
        run: |
          Write-Host "==================================="
          Write-Host "STEALTH VM INITIALIZATION"
          Write-Host "==================================="
          Write-Host "Start Time: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"
          Write-Host "Runner: $env:RUNNER_NAME"
          Write-Host "Region: $env:NGROK_REGION"

      - name: Setup Rclone (Cloud Sync)
        shell: powershell
        run: |
          Write-Host "Downloading Rclone..."
          $rcloneUrl = "https://downloads.rclone.org/rclone-current-windows-amd64.zip"
          Invoke-WebRequest -Uri $rcloneUrl -OutFile "rclone.zip"
          Expand-Archive -Path "rclone.zip" -DestinationPath "C:\rclone" -Force
          $rclonePath = Get-ChildItem -Path "C:\rclone" -Recurse -Filter "rclone.exe" | Select-Object -First 1
          Copy-Item $rclonePath.FullName -Destination "C:\Windows\System32\rclone.exe"
          Write-Host "Rclone installed: $(rclone version)"

      - name: Configure Cloud Storage
        shell: powershell
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG_DATA }}
        run: |
          Write-Host "Setting up cloud storage configuration..."
          $configDir = "$env:APPDATA\rclone"
          New-Item -ItemType Directory -Path $configDir -Force | Out-Null
          $env:RCLONE_CONFIG | Out-File -FilePath "$configDir\rclone.conf" -Encoding utf8
          Write-Host "Cloud storage configured"

      - name: Restore State (Auto-Heal)
        shell: powershell
        run: |
          Write-Host "Checking for existing state..."
          $statePath = "$env:STATE_PATH"
          
          try {
            # Try to download state.zip from cloud
            rclone copy "remote:EnterpriseState/state.zip" "C:\temp" -v
            
            if (Test-Path "C:\temp\state.zip") {
              Write-Host "State found! Restoring..."
              Expand-Archive -Path "C:\temp\state.zip" -DestinationPath $statePath -Force
              Write-Host "State restored successfully"
              Write-Host "Contents:"
              Get-ChildItem -Path $statePath -Recurse | Select-Object FullName, Length, LastWriteTime | Format-Table
            } else {
              Write-Host "No previous state found. Initializing fresh..."
              New-Item -ItemType Directory -Path $statePath -Force | Out-Null
              "VM initialized at $(Get-Date)" | Out-File "$statePath\init.txt"
            }
          } catch {
            Write-Host "State restore failed: $_"
            Write-Host "Creating fresh state..."
            New-Item -ItemType Directory -Path $statePath -Force | Out-Null
            "VM initialized at $(Get-Date)" | Out-File "$statePath\init.txt"
          }

      - name: Configure Windows RDP
        shell: powershell
        env:
          VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
        run: |
          Write-Host "Configuring RDP access..."
          
          # Set user password
          $password = if ($env:VM_PASSWORD) { $env:VM_PASSWORD } else { "StealthVM2026!" }
          net user runneradmin $password
          
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          Write-Host "RDP enabled for user: runneradmin"

      - name: Setup Ngrok Tunnel
        shell: powershell
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          Write-Host "Setting up Ngrok tunnel..."
          
          # Download Ngrok
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile "ngrok.zip"
          Expand-Archive -Path "ngrok.zip" -DestinationPath "C:\ngrok" -Force
          
          # Configure Ngrok
          & "C:\ngrok\ngrok.exe" config add-authtoken $env:NGROK_AUTH_TOKEN
          
          # Start Ngrok tunnel for RDP (port 3389)
          Start-Process -FilePath "C:\ngrok\ngrok.exe" -ArgumentList "tcp", "3389", "--region", "$env:NGROK_REGION" -WindowStyle Hidden
          
          Write-Host "Waiting for Ngrok to initialize..."
          Start-Sleep -Seconds 10
          
          # Get tunnel URL
          try {
            $ngrokApi = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels"
            $publicUrl = $ngrokApi.tunnels[0].public_url
            Write-Host ""
            Write-Host "=========================================="
            Write-Host "RDP CONNECTION DETAILS"
            Write-Host "=========================================="
            Write-Host "Ngrok URL: $publicUrl"
            Write-Host "Username: runneradmin"
            Write-Host "Password: [Check secrets]"
            Write-Host "=========================================="
            Write-Host ""
            
            # Save connection info to state
            @{
              timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC'
              ngrok_url = $publicUrl
              username = "runneradmin"
            } | ConvertTo-Json | Out-File "$env:STATE_PATH\connection_info.json"
            
            # Upload connection info immediately
            rclone copy "$env:STATE_PATH\connection_info.json" "remote:EnterpriseState/" -v
          
          } catch {
            Write-Host "Could not retrieve Ngrok URL: $_"
          }

      - name: Start Auto-Heal Sync Service
        shell: powershell
        run: |
          Write-Host "Starting auto-heal sync service..."
          
          $syncScript = @'
while ($true) {
  $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
  Write-Host "[$timestamp] Auto-Heal: Syncing state..."
  
  try {
    # Create state archive
    $statePath = $env:STATE_PATH
    $zipPath = "C:\temp\state.zip"
    
    if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
    Compress-Archive -Path "$statePath\*" -DestinationPath $zipPath -Force
    
    # Upload to cloud
    rclone copy $zipPath "remote:EnterpriseState/" -v
    
    $size = (Get-Item $zipPath).Length / 1MB
    Write-Host "[$timestamp] Sync complete! ($([math]::Round($size, 2)) MB)"
  } catch {
    Write-Host "[$timestamp] Sync failed: $_"
  }
  
  # Wait for next sync (30 minutes)
  Start-Sleep -Seconds $env:SYNC_INTERVAL
}
'@
          
          $syncScript | Out-File "C:\sync-service.ps1" -Encoding utf8
          Start-Process powershell -ArgumentList "-NoProfile", "-ExecutionPolicy", "Bypass", "-File", "C:\sync-service.ps1" -WindowStyle Hidden
          Write-Host "Auto-heal sync service started (interval: $env:SYNC_INTERVAL seconds)"

      - name: Send Discord Notification
        if: always()
        shell: powershell
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if ($env:DISCORD_WEBHOOK) {
            $connectionFile = "$env:STATE_PATH\connection_info.json"
            if (Test-Path $connectionFile) {
              $info = Get-Content $connectionFile | ConvertFrom-Json
              $body = @{
                content = "ðŸš€ **Stealth VM Active!**`nðŸ”— **URL:** $($info.ngrok_url)`nðŸ‘¤ **User:** $($info.username)`nðŸ•’ **Started:** $($info.timestamp)"
              } | ConvertTo-Json
              Invoke-RestMethod -Uri $env:DISCORD_WEBHOOK -Method Post -ContentType "application/json" -Body $body
              Write-Host "Discord notification sent"
            }
          }

      - name: Keep-Alive Loop
        shell: powershell
        run: |
          Write-Host "Entering keep-alive mode..."
          Write-Host "VM will remain active for the configured duration"
          Write-Host "Auto-heal sync running in background every 30 minutes"
          
          $startTime = Get-Date
          $duration = if ($env:DURATION) { [int]$env:DURATION } else { 5 }
          $endTime = $startTime.AddHours($duration)
          
          Write-Host "Started: $($startTime.ToString('yyyy-MM-dd HH:mm:ss'))"
          Write-Host "Will end: $($endTime.ToString('yyyy-MM-dd HH:mm:ss'))"
          
          while ((Get-Date) -lt $endTime) {
            $remaining = $endTime - (Get-Date)
            Write-Host "Time remaining: $($remaining.Hours)h $($remaining.Minutes)m" -NoNewline
            Write-Host "`r" -NoNewline
            Start-Sleep -Seconds 60
          }
          
          Write-Host "Keep-alive timeout reached."

      - name: Final State Backup
        if: always()
        shell: powershell
        run: |
          Write-Host "Performing final state backup..."
          try {
            $zipPath = "C:\temp\state.zip"
            Compress-Archive -Path "$env:STATE_PATH\*" -DestinationPath $zipPath -Force
            rclone copy $zipPath "remote:EnterpriseState/" -v
            Write-Host "Final backup complete!"
          } catch {
            Write-Host "Final backup failed: $_"
          }
